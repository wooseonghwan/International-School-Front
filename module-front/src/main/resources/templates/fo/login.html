<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/mainLayout}">
<div layout:fragment="contents" th:remove="tag">
    <div class="main-container">
        <div class="sign-head">
            <p class="title">로그인</p>
        </div>
        <div class="sign-form">
            <div class="form-field">
                <div class="form-wrap">
                    <p class="form-title">아이디</p>
                    <input type="text" class="form-control form-lg" placeholder="아이디를 입력해주세요." name="webId"/>
                </div>
            </div>
            <div class="form-field">
                <div class="form-wrap">
                    <p class="form-title">비밀번호</p>
                    <input type="password" class="form-control form-lg" placeholder="비밀번호를 입력해주세요." name="webPw"/>
                </div>
            </div>
            <div class="login-tool">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="flexRadioDefault" id="flexRadioDefault1"/>
                    <label class="form-check-label" for="flexRadioDefault1">아이디 저장</label>
                </div>
                <div class="desc">
                    <div class="find-desc">
                        <a href="" data-bs-toggle="modal" data-bs-target="#modal-find-id">아이디</a>
                        <a href="" data-bs-toggle="modal" data-bs-target="#modal-find-pw">/ 비밀번호 찾기</a>
                    </div>
                    <a href="/fo/signup">회원가입</a>
                </div>
            </div>
            <div class="btn-columns">
                <button type="button" class="btn btn-lg btn-primary" style="background-color: #ff974d;" data-role="login">로그인</button>
                <button type="button" class="btn btn-lg btn-outline-primary" onclick="location.href='/fo/signup'" >회원가입</button>
            </div>
        </div>
    </div>
    <!-- modal: 아이디 찾기 -->
    <div class="modal" tabindex="-1" id="modal-find-id">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">아이디 찾기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="sign-form">
                        <div class="form-field">
                            <div class="form-wrap">
                                <p class="form-title">*이름</p>
                                <input type="text" class="form-control form-lg" name="custName" placeholder="이름을 입력해주세요" />
                            </div>
                        </div>
                        <div class="form-field">
                            <div class="form-wrap">
                                <p class="form-title">*카드 아이디 번호</p>
                                <input type="text" class="form-control form-lg" name="cardId" placeholder="카드 ID 번호를 입력해주세요" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-columns">
                        <button type="button" class="btn btn-lg btn-primary" data-role="findId" style="background-color: #ff974d;">확인</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- modal: 아이디 찾기 완료 -->
    <div class="modal" tabindex="-1" id="modal-id-success">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">아이디 찾기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="sign-form">
                        <div class="success-form">
                            <p class="title">아이디</p>
                            <p class="result-txt" id="foundWebId"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-columns">
                        <button type="button" class="btn btn-lg btn-primary" style="background-color: #ff974d;" data-role="close-success-modal">확인</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- modal: 비밀번호 찾기 -->
    <div class="modal" tabindex="-1" id="modal-find-pw">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">비밀번호 찾기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="sign-form">
                        <div class="form-field">
                            <div class="form-wrap">
                                <p class="form-title">*아이디</p>
                                <input type="text" class="form-control form-lg" placeholder="" name="webId"/>
                            </div>
                        </div>
                        <div class="form-field">
                            <div class="form-wrap">
                                <p class="form-title">*이름</p>
                                <input type="text" class="form-control form-lg" placeholder="" name="custName"/>
                            </div>
                        </div>
                        <div class="form-field">
                            <div class="form-wrap">
                                <p class="form-title">*카드 아이디 번호</p>
                                <input type="text" class="form-control form-lg" placeholder="" name="cardId"/>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-columns">
                        <button type="button" class="btn btn-lg btn-primary" style="background-color: #ff974d;" data-role="findPw">확인</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- modal: 비밀번호 찾기 완료 -->
    <div class="modal" tabindex="-1" id="modal-pw-success">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">비밀번호 찾기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="sign-form">
                        <div class="success-form">
                            <p class="title">비밀번호</p>
                            <p class="result-txt" id="webPw">kljsfkjlksj</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-columns">
                        <button type="button" class="btn btn-lg btn-primary" style="background-color: #ff974d;">확인</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            const $webIdInput = $('input[name="webId"]');
            const $webPwInput = $('input[name="webPw"]');
            const $saveIdCheckbox = $('#flexRadioDefault1');

            // 1. 저장된 아이디 불러오기 (sessionStorage)
            const savedId = sessionStorage.getItem('savedWebId');
            if (savedId) {
                $webIdInput.val(savedId);
                $saveIdCheckbox.prop('checked', true);
            }

            // 2. Enter 키로 로그인
            $('.sign-form input').on('keyup', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    $('[data-role="login"]').click();
                }
            });

            // 3. 로그인 처리
            $('[data-role="login"]').on('click', function () {
                const webId = $.trim($webIdInput.val());
                const webPw = $.trim($webPwInput.val());

                if (!webId || !webPw) {
                    alert('아이디와 비밀번호를 모두 입력해주세요.');
                    return;
                }

                // 아이디 저장 처리 (sessionStorage)
                if ($saveIdCheckbox.is(':checked')) {
                    sessionStorage.setItem('savedWebId', webId);
                } else {
                    sessionStorage.removeItem('savedWebId');
                }

                $.ajax({
                    url: '/fo/login-check',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ webId, webPw }),
                    success: function (res) {
                        if (res.result === true) {
                            location.href = '/fo/main1';
                        } else {
                            alert(res.message || '아이디 또는 비밀번호가 올바르지 않습니다.');
                        }
                    },
                    error: function () {
                        alert('로그인 중 오류가 발생했습니다.');
                    }
                });
            });
        });
        // 아이디 찾기
        $('button[data-role=findId]').on('click', function () {
            const custName = $('#modal-find-id input[name="custName"]').val().trim();
            const cardId = $('#modal-find-id input[name="cardId"]').val().trim();

            if (!custName || !cardId) {
                alert('이름과 카드 ID를 모두 입력해주세요.');
                return;
            }

            $.ajax({
                url: '/fo/find-web-id',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ custName, cardId }),
                success: function (res) {
                    if (res.webId) {
                        // 아이디 표시 텍스트에 삽입
                        $('#foundWebId').text(res.webId);

                        // 기존 모달 닫기, 결과 모달 열기
                        $('#modal-find-id').modal('hide');
                        $('#modal-id-success').modal('show');
                    } else {
                        alert('일치하는 회원 정보를 찾을 수 없습니다.');
                    }
                },
                error: function () {
                    alert('아이디 찾기 요청 중 오류가 발생했습니다.');
                }
            });
        });
        // 아이디 찾기 모달 닫힐 때: 입력값 초기화
        $('#modal-find-id').on('hidden.bs.modal', function () {
            $(this).find('input[type="text"]').val('');
        });
        $('[data-role="close-success-modal"]').on('click', function () {
            $('#modal-id-success').modal('hide');
        });
        // 아이디 찾기 결과 모달 닫힐 때: 결과 텍스트 초기화
        $('#modal-id-success').on('hidden.bs.modal', function () {
            $('#foundWebId').text('');
        });
        // 비밀번호 찾기
        $('button[data-role=findPw]').on('click', function () {
            const webId = $('#modal-find-pw input[name="webId"]').val().trim();
            const custName = $('#modal-find-pw input[name="custName"]').val().trim();
            const cardId = $('#modal-find-pw input[name="cardId"]').val().trim();

            if (!webId || !custName || !cardId) {
                alert('아이디, 이름, 카드 ID를 모두 입력해주세요.');
                return;
            }

            $.ajax({
                url: '/fo/find-password',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ webId, custName, cardId }),
                success: function (res) {
                    if (res.webPw) {
                        $('#modal-pw-success .result-txt').text(res.webPw);

                        $('#modal-find-pw input[name="webId"]').val('');
                        $('#modal-find-pw input[name="custName"]').val('');
                        $('#modal-find-pw input[name="cardId"]').val('');

                        $('#modal-find-pw').modal('hide');
                        $('#modal-pw-success').modal('show');
                    } else {
                        alert('일치하는 회원 정보를 찾을 수 없습니다.');
                    }
                },
                error: function () {
                    alert('비밀번호 찾기 요청 중 오류가 발생했습니다.');
                }
            });
        });
        $('#modal-pw-success button.btn-primary').on('click', function () {
            $('#modal-pw-success').modal('hide');
        });
    </script>
</div>
</html>